from PythonJoernTests import *
from py2neo import Node

class AssignmentTests(PythonJoernTests):

    def testLVal(self):
        """Searches for all assignments in the file
        AgaviArrayPathDefinition.class.php and returns their left side."""
        query = """g.V().getAstOfFile("AgaviArrayPathDefinition.class.php").match{ isAssignment(it) }
                   .lval()"""
        result = self.j.runGremlinQuery(query)
        expect = [Node(childnum=0,index=14059,lineno=353,type="AST_VAR"),
                  Node(childnum=0,index=13940,lineno=313,type="AST_VAR"),
                  Node(childnum=0,index=13696,lineno=236,type="AST_VAR"),
                  Node(childnum=0,index=13692,lineno=235,type="AST_VAR"),
                  Node(childnum=0,index=13657,lineno=216,type="AST_VAR"),
                  Node(childnum=0,index=13512,lineno=202,type="AST_VAR"),
                  Node(childnum=0,index=13502,lineno=200,type="AST_VAR"),
                  Node(childnum=0,index=13358,lineno=168,type="AST_VAR"),
                  Node(childnum=0,index=13348,lineno=166,type="AST_VAR"),
                  Node(childnum=0,index=13200,lineno=133,type="AST_VAR"),
                  Node(childnum=0,index=13190,lineno=131,type="AST_VAR"),
                  Node(childnum=0,index=13168,lineno=113,type="AST_VAR"),
                  Node(childnum=0,index=12980,lineno=91,type="AST_VAR"),
                  Node(childnum=0,index=12975,lineno=89,type="AST_VAR"),
                  Node(childnum=0,index=12965,lineno=87,type="AST_VAR"),
                  Node(childnum=0,index=13014,lineno=94,type="AST_VAR"),
                  Node(childnum=0,index=13006,lineno=93,type="AST_VAR"),
                  Node(childnum=0,index=12991,lineno=92,type="AST_VAR"),
                  Node(childnum=0,index=13756,lineno=244,type="AST_VAR"),
                  Node(childnum=0,index=13752,lineno=243,type="AST_VAR"),
                  Node(childnum=0,index=13742,lineno=241,type="AST_DIM"),
                  Node(childnum=0,index=13708,lineno=237,type="AST_VAR"),
                  Node(childnum=0,index=12927,lineno=63,type="AST_VAR"),
                  Node(childnum=0,index=12917,lineno=62,type="AST_VAR"),
                  Node(childnum=0,index=14147,lineno=370,type="AST_DIM"),
                  Node(childnum=0,index=14132,lineno=368,type="AST_VAR"),
                  Node(childnum=0,index=14111,lineno=364,type="AST_VAR"),
                  Node(childnum=0,index=14034,lineno=330,type="AST_DIM"),
                  Node(childnum=0,index=14013,lineno=328,type="AST_VAR"),
                  Node(childnum=0,index=13992,lineno=324,type="AST_VAR"),
                  Node(childnum=0,index=13649,lineno=212,type="AST_VAR"),
                  Node(childnum=0,index=13896,lineno=288,type="AST_DIM"),
                  Node(childnum=0,index=14103,lineno=361,type="AST_VAR"),
                  Node(childnum=0,index=14091,lineno=359,type="AST_VAR"),
                  Node(childnum=0,index=13984,lineno=321,type="AST_VAR"),
                  Node(childnum=0,index=13972,lineno=319,type="AST_VAR"),
                  Node(childnum=0,index=13642,lineno=210,type="AST_DIM"),
                  Node(childnum=0,index=13591,lineno=207,type="AST_VAR"),
                  Node(childnum=0,index=13468,lineno=176,type="AST_VAR"),
                  Node(childnum=0,index=13437,lineno=173,type="AST_VAR"),
                  Node(childnum=0,index=13310,lineno=141,type="AST_VAR"),
                  Node(childnum=0,index=13279,lineno=138,type="AST_VAR"),
                  Node(childnum=0,index=13159,lineno=108,type="AST_VAR"),
                  Node(childnum=0,index=13091,lineno=97,type="AST_VAR"),
                  Node(childnum=0,index=13148,lineno=105,type="AST_VAR"),
                  Node(childnum=0,index=13127,lineno=101,type="AST_VAR"),
                  Node(childnum=0,index=13874,lineno=279,type="AST_VAR"),
                  Node(childnum=0,index=13858,lineno=272,type="AST_VAR"),
                  Node(childnum=0,index=13832,lineno=266,type="AST_VAR"),
                  Node(childnum=0,index=13815,lineno=258,type="AST_VAR"),
                  Node(childnum=0,index=13796,lineno=254,type="AST_VAR"),
                  Node(childnum=0,index=13792,lineno=253,type="AST_VAR"),
                  Node(childnum=0,index=13785,lineno=252,type="AST_DIM"),
                  Node(childnum=0,index=13854,lineno=270,type="AST_VAR"),
                  Node(childnum=0,index=13847,lineno=269,type="AST_DIM")
              ]
        self.assertEquals(result, expect)

    def testRVal(self):
        """Searches for all assignments in the file
        AgaviArrayPathDefinition.class.php and returns their right side."""
        query = """g.V().getAstOfFile("AgaviArrayPathDefinition.class.php").match{ isAssignment(it) }
                   .rval()"""
        result = self.j.runGremlinQuery(query)
        expect = [Node(childnum=1,index=14061,lineno=353,type="AST_ARRAY"),
                  Node(childnum=1,index=13942,lineno=313,type="AST_ARRAY"),
                  Node(childnum=1,flags=["BINARY_IS_NOT_EQUAL"],index=13698,lineno=236,type="AST_BINARY_OP"),
                  Node(childnum=1,index=13694,lineno=235,type="AST_ARRAY"),
                  Node(childnum=1,index=13659,lineno=216,type="AST_VAR"),
                  Node(childnum=1,index=13514,lineno=202,type="AST_VAR"),
                  Node(childnum=1,index=13504,lineno=200,type="AST_STATIC_CALL"),
                  Node(childnum=1,index=13360,lineno=168,type="AST_VAR"),
                  Node(childnum=1,index=13350,lineno=166,type="AST_STATIC_CALL"),
                  Node(childnum=1,index=13202,lineno=133,type="AST_VAR"),
                  Node(childnum=1,index=13192,lineno=131,type="AST_STATIC_CALL"),
                  Node(childnum=1,index=13170,lineno=113,type="AST_CONST"),
                  Node(childnum=1,index=12982,lineno=91,type="AST_CALL"),
                  Node(childnum=1,index=12977,lineno=89,type="AST_VAR"),
                  Node(childnum=1,index=12967,lineno=87,type="AST_STATIC_CALL"),
                  Node(childnum=1,flags=["BINARY_IS_EQUAL"],index=13016,lineno=94,type="AST_BINARY_OP"),
                  Node(childnum=1,index=13008,lineno=93,type="AST_DIM"),
                  Node(childnum=1,code="0",index=12993,lineno=92,type="integer"),
                  Node(childnum=1,index=13758,lineno=244,type="string"),
                  Node(childnum=1,code="0",index=13754,lineno=243,type="integer"),
                  Node(childnum=1,index=13746,lineno=241,type="AST_VAR"),
                  Node(childnum=1,index=13710,lineno=237,type="AST_CALL"),
                  Node(childnum=1,index=12929,lineno=63,type="AST_DIM"),
                  Node(childnum=1,index=12919,lineno=62,type="AST_STATIC_CALL"),
                  Node(childnum=1,index=14152,lineno=370,type="AST_VAR"),
                  Node(childnum=1,index=14134,lineno=368,type="AST_STATIC_CALL"),
                  Node(childnum=1,flags=["BINARY_CONCAT"],index=14113,lineno=364,type="AST_BINARY_OP"),
                  Node(childnum=1,index=14038,lineno=330,type="AST_VAR"),
                  Node(childnum=1,index=14015,lineno=328,type="AST_CALL"),
                  Node(childnum=1,flags=["BINARY_CONCAT"],index=13994,lineno=324,type="AST_BINARY_OP"),
                  Node(childnum=1,index=13651,lineno=212,type="AST_DIM"),
                  Node(childnum=1,index=13900,lineno=288,type="AST_VAR"),
                  Node(childnum=1,index=14105,lineno=361,type="AST_VAR"),
                  Node(childnum=1,flags=["BINARY_CONCAT"],index=14093,lineno=359,type="AST_BINARY_OP"),
                  Node(childnum=1,index=13986,lineno=321,type="AST_VAR"),
                  Node(childnum=1,flags=["BINARY_CONCAT"],index=13974,lineno=319,type="AST_BINARY_OP"),
                  Node(childnum=1,index=13647,lineno=210,type="AST_ARRAY"),
                  Node(childnum=1,flags=["TYPE_LONG"],index=13593,lineno=207,type="AST_CAST"),
                  Node(childnum=1,index=13470,lineno=176,type="AST_DIM"),
                  Node(childnum=1,flags=["TYPE_LONG"],index=13439,lineno=173,type="AST_CAST"),
                  Node(childnum=1,index=13312,lineno=141,type="AST_DIM"),
                  Node(childnum=1,flags=["TYPE_LONG"],index=13281,lineno=138,type="AST_CAST"),
                  Node(childnum=1,index=13161,lineno=108,type="AST_CONST"),
                  Node(childnum=1,flags=["TYPE_LONG"],index=13093,lineno=97,type="AST_CAST"),
                  Node(childnum=1,index=13150,lineno=105,type="AST_DIM"),
                  Node(childnum=1,index=13129,lineno=101,type="AST_DIM"),
                  Node(childnum=1,code="2",index=13876,lineno=279,type="integer"),
                  Node(childnum=1,code="2",index=13860,lineno=272,type="integer"),
                  Node(childnum=1,index=13834,lineno=266,type="AST_VAR"),
                  Node(childnum=1,index=13817,lineno=258,type="AST_VAR"),
                  Node(childnum=1,code="1",index=13798,lineno=254,type="integer"),
                  Node(childnum=1,index=13794,lineno=253,type="string"),
                  Node(childnum=1,index=13789,lineno=252,type="AST_VAR"),
                  Node(childnum=1,index=13856,lineno=270,type="string"),
                  Node(childnum=1,index=13851,lineno=269,type="AST_VAR")
              ]
        self.assertEquals(result, expect)
